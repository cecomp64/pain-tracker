<% provide :title, 'Pain Points' %>
<% provide :active, 'Pain Points' %>
<% provide :heading, "#{current_user.first_name ? current_user.first_name + "'" : ""} Pain Points" %>

<div class="row">
<div class="col-xs-6 button-heading">
  <%= link_to new_pain_point_path, class: 'btn btn-primary' do %>
    <span class="glyphicon glyphicon-plus"></span>
    Add Pain Point
  <% end %>
</div>

</div>

<div class="col-xs-12">
<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <th>Date</th>
        <th>Magnitude</th>
        <th>Activity</th>
        <th>Location</th>
        <th>Notes</th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      <%= content_tag_for(:tr, @pain_points) do |pain_point| %>
        <td><%= date_format pain_point.date %></td>
        <td><%= link_to pain_point.magnitude, pain_points_path(filter: {magnitude: pain_point.magnitude}) %></td>
        <td><%= link_to pain_point.activity ? pain_point.activity.name : 'None', pain_points_path(filter:
                                                                                                      {activity_id:
                                                                                                           pain_point
                                                                                                               .activity_id})
        %></td>
        <td><%= link_to pain_point.location ? pain_point.location.name : 'None', pain_points_path(filter:
            {location_id: pain_point.location_id})
        %></td>

        <td><%= pain_point.notes %></td>
        <td><%= link_to 'Show', pain_point %></td>
        <td><%= link_to 'Edit', edit_pain_point_path(pain_point) %></td>
        <td><%= link_to 'Destroy', pain_point, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      <% end %>
    </tbody>
  </table>
</div>
</div>
  <div class="col-xs-12">
    <%= form_tag(pain_points_upload_path, method: :post, multipart: true) do %>
      <%= file_field_tag(:file) %>
        <%= submit_tag('Upload CSV', class: 'btn btn-primary') %>
    <% end %>
  </div>
<%if !@pain_points.is_a?(Array) %>
<div class="col-xs-12">
  <h2><%=filter_title_for(@pain_points.first)%> Pain Over Time</h2>
  <%# Need to "reorder" or, remove the order clause before aggregating because pg sql is no bueno %>
  <%= line_chart @pain_points.reorder('').group(:date).sum(:magnitude) %>
  <%= bar_chart @pain_points.reorder('').group(:date).sum(:magnitude) %>
</div>
<% end %>
